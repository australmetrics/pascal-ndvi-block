name: Verificación de Calidad ISO 42001

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Permitir ejecución manual
  workflow_dispatch:

jobs:
  quality-check:
    name: Control de Calidad
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']  # Simplificamos a una sola versión para pruebas locales

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para verificación de historial

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install flake8 black mypy pytest pytest-cov bandit safety pydocstyle
          
      - name: Verificar formato de código
        run: |
          flake8 src/ tests/ --count --max-line-length=100 --statistics
          black --check src/ tests/

      - name: Verificar tipos
        run: |
          mypy src/ tests/

      - name: Ejecutar tests con cobertura
        run: |
          pytest tests/ --cov=src/ --cov-report=xml --cov-report=term-missing:skip-covered

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          fail_ci_if_error: true
          verbose: true

      - name: Verificar documentación
        run: |
          pydocstyle src/

      - name: Verificar seguridad
        run: |
          bandit -r src/ -ll

      - name: Verificar dependencias
        run: |
          safety check

  compliance-check:
    name: Verificación ISO 42001
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Verificar estructura de logging
        run: |
          test -f "src/logging_config.py" || exit 1

      - name: Verificar documentación ISO 42001
        run: |
          test -f "docs/compliance/iso42001_compliance.md" || exit 1

      - name: Verificar archivos requeridos
        run: |
          for file in README.md CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md; do
            test -f "$file" || exit 1
          done

  notify:
    name: Notificación de Resultados
    needs: [quality-check, compliance-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Resultado de verificación
        shell: bash
        run: |
          if [ "${{ needs.quality-check.result }}" == "success" ] && [ "${{ needs.compliance-check.result }}" == "success" ]; then
            echo "✅ Verificación exitosa - ISO 42001 Compliance Check"
            exit 0
          else
            echo "❌ Verificación fallida - ISO 42001 Compliance Check"
            exit 1
          fi
